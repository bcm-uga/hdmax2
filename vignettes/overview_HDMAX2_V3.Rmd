---
title: "Overview of R Package hdmax2"
author: "Florence Pittion, Magali Richard, Olivier Francois"
date: "January, 2024"
output:
  prettydoc::html_pretty:
    self_contained: true
    theme: cayman
    highlight: github
vignette: >
  %\VignetteIndexEntry{overview_HDMAX2_V3.Rmd}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

***

**Summary:**

***

# Introduction 

*HDMAX2* is an efficient algorithm for high dimensional mediation analysis using max-squared tests.
*HDMAX2* is structured in two main steps:
Step 1. Evaluating associations between exposure, mediators and outcome, using a latent factor mixed models (LFMMs) to estimate the effects of exposure $X$ on a matrix $M$ of potential mediators, and the effect of each marker on outcome $Y$.

$$
 M=Xa^T +U_1V_1^T +E_1
$$
$a$ the vector of effect sizes of exposure on mediators levels,
$U$ the matrix formed of K latent factors estimated simultaneously with a,
$V$ loadings associated with the latent factors,
$E_1$ the matrix of residual errors.

$$
Y=Xc+Mb^T +U_2V_2^T +E_2 
$$
$c$ the direct effect of exposure on outcome,
$b$ the effect sizes of mediators on outcome,
$U_2$ the latent factors from a latent factor regression model,
$V_2$ the corresponding loadings,
$E_2$ the a matrix of errors.

and identifying potential mediators, combining the significance values $P_x$ and $P_y$ to compute a P-value for each mediators with *max²* test.
$$
P = max(P_x, P_y)^2
$$
Step 2. Estimation of the individual indirect effects of mediators via the **mediation** package.

A novelty of HDMAX2 is to evaluate an overall (cumulated) indirect effect for all mediators identified in Step 3. The overall indirect effect (OIE) was estimated in a model including m mediator variables as follows:

$$
y_i = cx_i + \sum_{j=1}^{m} b_jm_{ij}+ \sum_{k=1}^{K} v_k u_{ik} + \epsilon_i
$$

$$
OIE = \sum _{j=1} ^m a_j b_j 
$$


To install the latest version of **hdmax2**, use the github repository 
```{r}
#devtools::install_github("bcm-uga/hdmax2")
```


# Simulated dataset

- 100 samples and 500 potential mediators from simulated data were analysed.

- 3 types pf exposures (continuous, binary, categorial)

- 2 types of outcomes (continuous, binary)

```{r}
load("../data/simu_data.RData")
X_continuous = as.matrix(simu_data$X_continuous)
X_binary = as.matrix(simu_data$X_binary)
X_categorial = simu_data$X_categorial
Y_continuous = as.matrix(simu_data$Y_continuous)
Y_binary = as.matrix(simu_data$Y_binary)
M = as.matrix(simu_data$M)
age = as.matrix(simu_data$age)
gender = as.matrix(simu_data$gender)

```


# Latent factor number estimation

 In order to estimate how many latent factors can be inferred from the potential mediators matrix, we performed a principal component analysis (PCA). 

```{r}
res_pca = FactoMineR::PCA(M, graph = F)
factoextra::fviz_screeplot(res_pca, ncp=10)

#pca conclusion
K=5
```
The screeplot indicates around 5 main components in the data. We will use $K = 5$ latent factors in subsequent analyses.

# First use case  *binary exposure* and *continuous outcome*

### Evaluating associations between exposure, mediators and outcome

The **run_AS** function is applied to estimate the effects of exposure $X$ on a matrix $M$ of potential mediators, and the effect of each potential mediators on outcome $Y$.

```{r}
# plot(Y_continuous, X_binary)
# summary(lm(Y_continuous~X_binary))
# step 1 association studies + max2
res_step1 = hdmax2::run_AS(X_matrix = X_binary ,
                 Y_matrix = Y_continuous,
                 M_matrix = M, 
                 K = K,
                 X_type = "binary",
                 Y_type = "continuous",
                 M_type = "methylation",
                 multivariate = FALSE,
                 covar = cbind(age, gender),
                 diagnostic.plot = F)
# max2 test results
head(res_step1$max2)

```

The function estimates for each regression:

- *p-values* to assess signification of the regression

- *effects sizes* of the regression

- *latent factor effect* (when regression type is compatible)

- *z-score*

- *gif* : genomic inflation factor which expresses the deviation of the distribution of the observed test statistic compared to the distribution of the expected test statistic. In case of highly stratified population (high gif), it allows to calibrate P-values without excess false positive rate.


It also estimate results of *max²*  test which identifying potential CpG mediators:
combining the significance values *pvalues*.
This rejects the null-hypothesis that either the effect of exposure on potential mediators or the effect of potential mediators on outcome is null. *run_AS* function also provides results from max² test:

- *p-value* of each test


In this example, we will consider the 10 first selected mediators.


```{r}
##Selecting mediators
## top 10 selecting mediators
mediators_top10 = M[,names(sort(res_step1$max2)[1:10])]
head(mediators_top10)

```

### Mediators individual indirect effect estimation and Overall Indirect Effect estimation.

The function **estimate_effect** estimate the individual indirect effect of mediators.

```{r}
## selected mediators effects estimation
res_step2 = hdmax2::estimate_effect(object = res_step1,
                                    m = mediators_top10,
                                     boots = 100,
                                    sims = 100)

##The parameter sims is the number of Monte Carlo draws for nonparametric bootstrap or quasi-Bayesian approximation. 10000 is recommended, but we used 100 for the example.
```

Estimation of **average causal mediation effect (ACME)** is the indirect effect. 

Other effect estimated include :

   - Average direct effect (ADE) 

   - Proportion mediated (PM) 

   - Total effect (TE)

```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_step2$ACME)
head(res_step2$ADE)
head(res_step2$PM)
head(res_step2$TE)
```



We propose a set of plots which include:

- Forest plot of mediators ACME

- Forest plot of mediators PM 

- Comparison of ODE, OIE and OTE

- Mediators effect size representation


```{r}
## mediators ACME plots 
hdmax2::plot(res_step2, N_med = 10)
```





# Use case 2  **continuous exposure** and **continuous outcome**


### Evaluating associations between exposure, mediators and outcome


```{r}
# step 1 association studies + max2
res_step1 = hdmax2::run_AS(X_matrix = X_continuous ,
                           Y_matrix = Y_continuous,
                           M_matrix = M, 
                           K = K,
                           X_type = "continuous",
                           Y_type = "continuous",
                           M_type = "methylation",
                           multivariate = FALSE,
                           covar  = cbind(age, gender),
                           diagnostic.plot = F)
# max2 test results
head(res_step1$max2)

```


```{r}
##Selecting mediators
mediators_top10 = M[,names(sort(res_step1$max2)[1:10])]
head(mediators_top10)
```

### Mediators individual indirect effect estimation and Overall Indirect Effect estimation.


```{r}
## selected mediators effects estimation
res_step2 = hdmax2::estimate_effect(res_step1,
                                    m = mediators_top10,
                                    boots = 100,
                                    sims = 100)

##The parameter sims is the number of Monte Carlo draws for nonparametric bootstrap or quasi-Bayesian approximation. 10000 is recommended, but we used 100 for the example.
```



```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_step2$ACME)
head(res_step2$ADE)
head(res_step2$PM)
head(res_step2$TE)
```


```{r}
## mediators ACME plots 
hdmax2::plot(res_step2, N_med = 10)
```





# Use case 3 **continuous exposure** and **binary outcome**


### Evaluating associations between exposure, mediators and outcome


```{r, warning=FALSE}
# step 1 association studies + max2
res_step1 = hdmax2::run_AS(X_matrix = X_continuous ,
                 Y_matrix = Y_binary,
                 M_matrix = M, 
                 K = K,
                 X_type = "continuous",
                 Y_type = "binary",
                 M_type = "methylation",
                 multivariate = FALSE,
                 covar = cbind(age, gender),
                 diagnostic.plot = F)
# max2 test results
head(res_step1$max2)
```



```{r}
##Selecting mediators
mediators_top10 = M[,names(sort(res_step1$max2)[1:10])]
head(mediators_top10)
```

### Mediators individual indirect effect estimation and Overall Indirect Effect estimation.


```{r}
res_step2 = hdmax2::estimate_effect(res_step1,
                                    m = mediators_top10,
                                    boots = 100,
                                    sims = 100)
# max2 test results
head(res_step1$max2)
##The parameter sims is the number of Monte Carlo draws for nonparametric bootstrap or quasi-Bayesian approximation. 10000 is recommended, but we used 100 for the example.
```


```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_step2$ACME)
head(res_step2$ADE)
head(res_step2$PM)
head(res_step2$TE)
```


```{r}
## mediators ACME plots 
hdmax2::plot(res_step2, N_med = 10)
```



# Use case 3 **binary exposure** and **binary outcome**


### Evaluating associations between exposure, mediators and outcome


```{r, warning=FALSE}
# step 1 association studies + max2
res_step1 = hdmax2::run_AS(X_matrix = X_binary ,
                 Y_matrix = Y_binary,
                 M_matrix = M, 
                 K = K,
                 X_type = "binary",
                 Y_type = "binary",
                 M_type = "methylation",
                 multivariate = FALSE,
                 covar = NULL,
                 diagnostic.plot = F)
# max2 test results
head(res_step1$max2)
```



```{r}
##Selecting mediators
mediators_top10 = M[,names(sort(res_step1$max2)[1:10])]
head(mediators_top10)
```

### Mediators individual indirect effect estimation and Overall Indirect Effect estimation.


```{r}
res_step2 = hdmax2::estimate_effect(res_step1,
                                    m = mediators_top10,
                                    boots = 100,
                                    sims = 100)
# max2 test results
head(res_step1$max2)
##The parameter sims is the number of Monte Carlo draws for nonparametric bootstrap or quasi-Bayesian approximation. 10000 is recommended, but we used 100 for the example.
```


```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_step2$ACME)
head(res_step2$ADE)
head(res_step2$PM)
head(res_step2$TE)
```


```{r}
## mediators ACME plots 
hdmax2::plot(res_step2, N_med = 10)
```


# Use case 5  **categorial exposure** and **binary outcome**

## without covar



### First option a single pvalue results via partial regressions

```{r, warning=FALSE}
# step 1 association studies + max2
res_step1 = hdmax2::run_AS(X_matrix = X_categorial ,
                 Y_matrix = Y_binary,
                 M_matrix = M, 
                 K = K,
                 X_type = "categorial",
                 Y_type = "binary",
                 M_type = "methylation",
                 covar = NULL,
                 diagnostic.plot = F)

```



```{r}
##Selecting mediators

mediators_top10 = M[,names(sort(res_step1$max2)[1:10])]
head(mediators_top10)


# pas possible de calculer les effets dans cette configuration juste une list de mediateurs
```

For this case we can't propose effect estimation (TODO expliquer pourquoi)



### Second option multimediate results, pvalue and mediators selection for each category of the exposure

```{r, warning = FALSE}
res_step1 = hdmax2::run_AS(X_matrix = X_categorial ,
                 Y_matrix = Y_binary,
                 M_matrix = M, 
                 K = K,
                 X_type = "categorial",
                 Y_type = "binary",
                 M_type = "methylation",
                 multivariate = TRUE,
                 covar = NULL,
                 diagnostic.plot = F)
# max2 test results
head(res_step1$max2[1,])

```

```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_step2$ACME)
head(res_step2$ADE)
head(res_step2$PM)
head(res_step2$TE)
```

```{r}
# first variable category selected mediators 
mediators_top10 = M[,names(sort(res_step1$max2[1,]))[1:10]]
head(mediators_top10)

# one hot encoding
# X_categorial = droplevels(X_categorial)
# X_categorial = mltools::one_hot(data.table::as.data.table(X_categorial))
# 
# # first variable category extraction
# X_cat_var1 = as.double(as.matrix(X_categorial[,1]))

## TODO return error message if X = multiple categories
    
res_step2 = hdmax2::estimate_effect(res_step1,
                                    m = mediators_top10,
                                    boots = 100,
                                    sims = 100,
                                    multivariate = TRUE)

```

```{r}
## mediators ACME plots 
hdmax2::plot(res_step2, N_med = 10)
```

## with covar



### First option a single pvalue results via partial regressions

```{r, warning=FALSE}
# step 1 association studies + max2
res_step1 = hdmax2::run_AS(X_matrix = X_categorial ,
                 Y_matrix = Y_binary,
                 M_matrix = M, 
                 K = K,
                 X_type = "categorial",
                 Y_type = "binary",
                 M_type = "methylation",
                 covar = cbind(gender, age),
                 diagnostic.plot = F)

```



```{r}
##Selecting mediators

mediators_top10 = M[,names(sort(res_step1$max2)[1:10])]
head(mediators_top10)


# pas possible de calculer les effets dans cette configuration juste une list de mediateurs
```

For this case we can't propose effect estimation (TODO expliquer pourquoi)



### Second option multimediate results, pvalue and mediators selection for each category of the exposure

```{r, warning = FALSE}
res_step1 = hdmax2::run_AS(X_matrix = X_categorial ,
                 Y_matrix = Y_binary,
                 M_matrix = M, 
                 K = K,
                 X_type = "categorial",
                 Y_type = "binary",
                 M_type = "methylation",
                 multivariate = TRUE,
                 covar = cbind(age, gender),
                 diagnostic.plot = F)
# max2 test results
head(res_step1$max2[1,])

```

```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_step2$ACME)
head(res_step2$ADE)
head(res_step2$PM)
head(res_step2$TE)
```

```{r}
# first variable category selected mediators 
mediators_top10 = M[,names(sort(res_step1$max2[1,]))[1:10]]
head(mediators_top10)

## TODO return error message if X = multiple categories
    
res_step2 =  hdmax2::estimate_effect(res_step1,
                                    m = mediators_top10,
                                    boots = 100,
                                    sims = 100,
                            multivariate = TRUE)

```

```{r}
## mediators ACME plots 
hdmax2::plot(res_step2, N_med = 10)
```


## V2

```{r}
# first variable category selected mediators 
mediators_top10 = M[,names(sort(res_step1$max2[1,]))[1:10]]
head(mediators_top10)

## TODO return error message if X = multiple categories
    
res_step2 =  hdmax2::estimate_effect_V2(res_step1,
                                    m = mediators_top10,
                                    boots = 100,
                                    sims = 100,
                            multivariate = TRUE)

```

```{r}
## mediators ACME plots 
hdmax2::plot(res_step2, N_med = 10)
```
