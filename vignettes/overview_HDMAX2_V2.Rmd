---
title: "Overview of R Package hdmax2"
author: "Florence Pittion, Magali Richard, Olivier Francois"
date: "January, 2024"
output:
  prettydoc::html_pretty:
    self_contained: true
    theme: cayman
    highlight: github
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

***

**Summary:**

***

# Introduction 

*HDMAX2* is an efficient algorithm for high dimensional mediation analysis using max-squared tests.
*HDMAX2* is structured in two main steps:
Step 1. Evaluating associations between exposure, mediators and outcome, using a latent factor mixed models (LFMMs) to estimate the effects of exposure $X$ on a matrix $M$ of potential mediators, and the effect of each marker on outcome $Y$.

$$
 M=Xa^T +U_1V_1^T +E_1
$$
$a$ the vector of effect sizes of exposure on mediators levels,
$U$ the matrix formed of K latent factors estimated simultaneously with a,
$V$ loadings associated with the latent factors,
$E_1$ the matrix of residual errors.

$$
Y=Xc+Mb^T +U_2V_2^T +E_2 
$$
$c$ the direct effect of exposure on outcome,
$b$ the effect sizes of mediators on outcome,
$U_2$ the latent factors from a latent factor regression model,
$V_2$ the corresponding loadings,
$E_2$ the a matrix of errors.

and identifying potential mediators, combining the significance values $P_x$ and $P_y$ to compute a P-value for each mediators with *max²* test.
$$
P = max(P_x, P_y)^2
$$
Step 2. Estimation of the individual indirect effects of mediators via the **mediation** package and estimation of the **overall indirect effect** of all the mediators, with the following formula.

$$
OIE = \sum _{j=1} ^m a_j b_j 
$$


To install the latest version of **hdmax2**, use the github repository 
```{r}
#devtools::install_github("bcm-uga/hdmax2")
```

***
# Starting with hdmax2


Data set is produce from transcription, methylation and patients meta data of PDAC (Pancreatic Ductal AdenoCarcinoma) TCGA data. 

## First use case 

For this first use case we used *binary exposition* and *continuous outcome*, we analyzed 100 samples and 500 potential mediators.

```{r}
load("../data/sample_hdmax2_data.RData")
X = as.matrix(sample_hdmax2_data$X_binary)
Y = as.matrix(sample_hdmax2_data$Y_time)
M = as.matrix(sample_hdmax2_data$M)

```
***

### Evaluating associations between exposure, mediators and outcome

In order to estimate how many latent factors can be inferred from the potential mediators matrix, we performed a principal component analysis (PCA). 

```{r}
res_pca = FactoMineR::PCA(M, graph = F)
factoextra::fviz_screeplot(res_pca, ncp=10)
```

The screeplot indicates around 5 main components in the data. We will use $K = 5$ latent factors in subsequent analyses.

The **runAS** function is applied to estimate the effects of exposure $X$ on a matrix $M$ of potential mediators, and the effect of each potential mediators on outcome $Y$.

```{r}
# step 1 association studies + max2
res_step1 = hdmax2::runAS(X_matrix = X ,
                 Y_matrix = Y,
                 M_matrix = M, 
                 K = 5,
                 X_type = "binary",
                 Y_type = "continuous",
                 M_type = "methylation",
                 conf = NULL,
                 diagnostic.plot = F)
```

The function estimates for each regression:

- *p-values* to assess signification of the regression

- *effects sizes* of the regression

- *latent factor effect* (when regression type is compatible)

- *z-score*

- *gif* : genomic inflation factor which expresses the deviation of the distribution of the observed test statistic compared to the distribution of the expected test statistic. In case of highly stratified population (high gif), it allows to calibrate P-values without excess false positive rate.


It also estimate results of *max²*  test which identifying potential CpG mediators:
combining the significance values *pvalues*.
This rejects the null-hypothesis that either the effect of exposure on potential mediators or the effect of potential mediators on outcome is null. *runAS* function also provides results from max² test:

- *p-value* of each test

- *eta0* for each test, the local false discovery rate (FDR) parameter

- *q-value* of each test




```{r}
# first regression
head(res_step1$mod1$pval)
head(res_step1$mod1$effect.sizes)
head(res_step1$mod1$zscores)
head(res_step1$mod1$gif)

# second regression
head(res_step1$mod2$pval)
head(res_step1$mod2$effect.sizes)
head(res_step1$mod2$zscores)
head(res_step1$mod2$gif)

# max2 test results
head(res_step1$max2$pval)
head(res_step1$max2$eta0)
head(res_step1$max2$qval)
```


***

In this example, we will consider FDR levels <10%.


```{r}
##Selecting mediators
FDR=0.1
mediators = res_step1$max2$qval[res_step1$max2$qval<= FDR]
mediators
```

### Mediators individual indirect effects estimation

The function **acme_mediation** estimate the individual indirect effect of mediators
```{r}
## selected mediators effects estimation
res_med = hdmax2::acme_mediation(qval = res_step1$max2$qval,
                            X = X,
                            Y = Y,
                            M = M,
                            U = res_step1$mod1$U,
                            sims = 100, FDR = FDR,
                            mod2_type = "linear")

##The parameter sims is the number of Monte Carlo draws for nonparametric bootstrap or quasi-Bayesian approximation. 10000 is recommended, but we used 100 for the example.
```

Estimation of average causal mediation effect (ACME) is the indirect effect. Other effect estimated include average direct effect (ADE), proportion mediated (PM), and total effect (TE).

```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_med$ACME)
head(res_med$ADE)
head(res_med$PM)
head(res_med$TE)
```


```{r}
## mediators ACME plots 
hdmax2::plot_summary_ACME(ACME = res_med$ACME)
```

### Mediators Overall Indirect Effect (OIE) estimation

A novelty of HDMAX2 is to evaluate an overall (cumulated) indirect effect for all CpGs or AMRs identified in Step 3. The overall indirect effect (OIE) was estimated in a model including m mediator variables as follows:

$$
y_i = cx_i + \sum_{j=1}^{m} b_jm_{ij}+ \sum_{k=1}^{K} v_k u_{ik} + \epsilon_i
$$


```{r}
## OIE estimation and boxplot
m = M[,names(sort(mediators))]
res_oie = hdmax2::oie_estimation(X=X, C=res_step1$mod1$U, m = m, Y=Y, boots = 100 )
median(res_oie)
boxplot(res_oie, horizontal =F, main = "OIE estimation 100 bootstraps", col = "blue")
```











## Second use case 

For this second use case we used **continuous exposition** and **continuous outcome**, we analyzed 100 samples and 500 potential mediators.

```{r}
X = sample_hdmax2_data$X_continuous
Y = sample_hdmax2_data$Y_time
M = sample_hdmax2_data$M
```
***

### Evaluating associations between exposure, mediators and outcome


```{r}
# step 1 association studies + max2
res_step1 = hdmax2::runAS(X_matrix = X ,
                 Y_matrix = Y,
                 M_matrix = M, 
                 K = 5,
                 X_type = "continuous",
                 Y_type = "continuous",
                 M_type = "methylation",
                 conf = NULL,
                 diagnostic.plot = F)
```



```{r, eval=T}
# first regression
head(res_step1$mod1$pval)
head(res_step1$mod1$effect.sizes)
head(res_step1$mod1$zscores)
head(res_step1$mod1$gif)

# second regression
head(res_step1$mod2$pval)
head(res_step1$mod2$effect.sizes)
head(res_step1$mod2$zscores)
head(res_step1$mod2$gif)
 
# max2 test results
head(res_step1$max2$pval)
head(res_step1$max2$eta0)
head(res_step1$max2$qval)
```




```{r}
##Selecting mediators
FDR=0.1
mediators = res_step1$max2$qval[res_step1$max2$qval<= FDR]
mediators
```

### Mediators individual indirect effects estimation


```{r}
## selected mediators effects estimation
res_med = hdmax2::acme_mediation(qval = res_step1$max2$qval,
                         X = X,
                         Y = Y,
                         M = M,
                         U = res_step1$mod1$U,
                         sims = 100, 
                         FDR = FDR,
                         mod2_type = "linear")

##The parameter sims is the number of Monte Carlo draws for nonparametric bootstrap or quasi-Bayesian approximation. 10000 is recommended, but we used 100 for the example.
```



```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_med$ACME)
head(res_med$ADE)
head(res_med$PM)
head(res_med$TE)
```


```{r}
## mediators ACME plots 
hdmax2::plot_summary_ACME(ACME = res_med$ACME)
```

### Mediators Overall Indirect Effect (OIE) estimation

```{r, eval = F}
m = M[,names(sort(mediators))]
res_oie = hdmax2::oie_estimation(X=X, C=res_step1$mod1$U, m = m, Y=Y, boots = 100 )
median(res_oie)
boxplot(res_oie, horizontal =F, main = "OIE estimation 100 bootstraps", col = "blue")
```




## third use case 

For this second use case we used **continuous exposition** and **binary outcome**, we analyzed 100 samples and 500 potential mediators.

```{r}
X = sample_hdmax2_data$X_continuous
Y = sample_hdmax2_data$Y_binary
M = sample_hdmax2_data$M
```
***

### Evaluating associations between exposure, mediators and outcome


```{r}
# step 1 association studies + max2
res_step1 = hdmax2::runAS(X_matrix = X ,
                 Y_matrix = Y,
                 M_matrix = M, 
                 K = 5,
                 X_type = "continuous",
                 Y_type = "continuous", # even if it is binary
                 #Y_type = "binary",
                 M_type = "methylation",
                 conf = NULL,
                 diagnostic.plot = F)
```



```{r, eval = T}
# first regression
head(res_step1$mod1$pval)
head(res_step1$mod1$effect.sizes)
head(res_step1$mod1$zscores)
head(res_step1$mod1$gif)

# second regression
head(res_step1$mod2$pval)
head(res_step1$mod2$effect.sizes)
head(res_step1$mod2$zscores)
head(res_step1$mod2$gif)

# max2 test results
head(res_step1$max2$pval)
head(res_step1$max2$eta0)
head(res_step1$max2$qval)
```




```{r}
##Selecting mediators
FDR=0.1
mediators = res_step1$max2$qval[res_step1$max2$qval<= FDR]
mediators
```

### Mediators individual indirect effects estimation


```{r}
res_med = hdmax2::acme_mediation(qval = res_step1$max2$qval,
                            X = X,
                            Y = Y,
                            M = M,
                            U = res_step1$mod1$U,
                            sims = 100, 
                            FDR = FDR, 
                            mod2_type = "linear")

##The parameter sims is the number of Monte Carlo draws for nonparametric bootstrap or quasi-Bayesian approximation. 10000 is recommended, but we used 100 for the example.
```


```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_med$ACME)
head(res_med$ADE)
head(res_med$PM)
head(res_med$TE)
```


```{r}
## mediators ACME plots 
hdmax2::plot_summary_ACME(ACME = res_med$ACME)
```






## Fourth use case 

For this fourth use case we used **continuous exposition** and **survival outcome**, we analyzed 100 samples and 500 potential mediators.

```{r}
X = sample_hdmax2_data$X_continuous
Y = sample_hdmax2_data$Y_coxSurv
M = sample_hdmax2_data$M
```
***

### Evaluating associations between exposure, mediators and outcome


```{r}
# step 1 association studies + max2
res_step1 = hdmax2::runAS(X_matrix = X ,
                 Y_matrix = Y,
                 M_matrix = M, 
                 K = 5,
                 X_type = "continuous",
                 Y_type = "surv_Cox",
                 #Y_type = "binary",
                 M_type = "methylation",
                 conf = NULL,
                 diagnostic.plot = F)
```



```{r, eval = T}
# first regression
head(res_step1$mod1$pval)
head(res_step1$mod1$effect.sizes)
head(res_step1$mod1$zscores)
head(res_step1$mod1$gif)

# second regression
head(res_step1$mod2$pval)
head(res_step1$mod2$effect.sizes)
head(res_step1$mod2$zscores)
head(res_step1$mod2$gif)
 
# max2 test results
head(res_step1$max2$pval)
head(res_step1$max2$eta0)
head(res_step1$max2$qval)
```




```{r}
##Selecting mediators
FDR=0.5
mediators = res_step1$max2$qval[res_step1$max2$qval<= FDR]
mediators
```

### Mediators individual indirect effects estimation


```{r}
res_med = hdmax2::acme_mediation(qval = res_step1$max2$qval,
                            X = X,
                            Y = Y,
                            M = M,
                            U = res_step1$mod1$U,
                            sims = 100, 
                            FDR = FDR, 
                            mod2_type = "surv_Cox")

##The parameter sims is the number of Monte Carlo draws for nonparametric bootstrap or quasi-Bayesian approximation. 10000 is recommended, but we used 100 for the example.
```



```{r}
# ACME, ADE, PM, TE estimation with CI
head(res_med$ACME)
head(res_med$ADE)
head(res_med$PM)
head(res_med$TE)
```


```{r}
## mediators ACME plots 
hdmax2::plot_summary_ACME(ACME = res_med$ACME)
```

### Mediators Overall Indirect Effect (OIE) estimation

```{r, eval = F}
m = M[,names(sort(mediators))]
# res_oie = hdmax2::oie_estimation(X=X, C=res_step1$mod1$U, m = m, Y=Y, boots = 100 )
# median(res_oie)

res_oie = hdmax2::oie_estimation(X=X, C=NULL, m = m, Y=Y, boots = 100 )
median(res_oie)
boxplot(res_oie, horizontal =F, main = "OIE estimation 100 bootstraps", col = "blue")
```




